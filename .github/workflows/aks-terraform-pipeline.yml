name: AKS Terraform Pipeline

on:
  push:
    branches:
      - main
      - 'release/**'
  pull_request:
    types: [opened, synchronize, reopened]

env:
  AZURE_REGION: 'australiacentral'

permissions:
  contents: read
  issues: write
  pull-requests: write
  security-events: write

jobs:
  security-scan:
    name: Security Scan with Checkov
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq (for JSON parsing)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run Checkov (action)
        id: checkov
        uses: bridgecrewio/checkov-action@v14
        with:
          args: >
            --directory . --framework terraform
            -o json --output-file-path checkov-report.json
            -o junitxml --output-file-path checkov-report.xml
        continue-on-error: true

      - name: Parse Checkov JSON for HIGH/CRITICAL
        id: parse
        run: |
          if [ -f checkov-report.json ]; then
            HIGH_COUNT=$(jq '[.results.failed_checks[] | select(.severity=="HIGH" or .severity=="CRITICAL")] | length' checkov-report.json)
          else
            HIGH_COUNT=0
          fi
          echo "high_count=$HIGH_COUNT" >> $GITHUB_OUTPUT

      - name: Upload Checkov reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkov-security-report
          path: |
            checkov-report.json
            checkov-report.xml
          if-no-files-found: warn
          retention-days: 30

      - name: Comment PR with scan summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const highCount = parseInt(process.env.HIGH_COUNT || '${{ steps.parse.outputs.high_count }}' || 0);
            const emoji = highCount > 0 ? '⚠️' : '✅';
            const statusText = highCount > 0 ? `Issues found: ${highCount} HIGH/CRITICAL` : 'No HIGH/CRITICAL issues found';
            const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            const body = `## ${emoji} Checkov Security Scan Summary

            - **Status:** ${statusText}
            - **Checkov report:** [Action run and artifacts](${runUrl})

            ${ highCount > 0 ? '> This PR is blocked until HIGH/CRITICAL issues are resolved.' : '' }

            <details>
            <summary>Scan details</summary>

            - JSON report: checkov-report.json
            - JUnit report: checkov-report.xml

            </details>
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
        env:
          HIGH_COUNT: ${{ steps.parse.outputs.high_count }}

      - name: Fail on HIGH/CRITICAL findings
        if: steps.parse.outputs.high_count != '0'
        run: |
          echo "Failing job because ${{ steps.parse.outputs.high_count }} HIGH/CRITICAL Checkov findings were detected."
          exit 1

  terraform:
    name: Terraform Plan/Apply
    runs-on: ubuntu-latest
    needs: security-scan
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Placeholder - Terraform steps
        run: echo "Add your Terraform plan/apply steps here"